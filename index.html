<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<link rel="icon" href="img/Logo Rental.png" sizes="32x32">
<link rel="icon" href="img/Logo Rental.png" sizes="48x48">
<link rel="apple-touch-icon" href="img/Logo Rental.png">
<title>Aplikasi Sewa Motor Rental Merah Putih</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- jsPDF AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
window.addEventListener("scroll", () => {
  document.querySelector(".navbar")
    .classList.toggle("scrolled", window.scrollY > 50);
});
</script>


<style>
  body { font-family: Inter, sans-serif; padding:20px; background:#f6f7fb; }
  .container { max-width:1100px; margin:auto; }
  h1 { margin:0; font-size:22px; }
  .btn { background:#2b7a78; color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
  .grid {display: grid;grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));gap: 20px}
  .card { background:rgb(255, 255, 255); padding:14px; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,0.08); overflow: hidden;}
  .motor-img { height:180px; border-radius:8px; background:rgb(210, 210, 250); overflow: hidden;  display:flex; align-items:flex-end; justify-content:center; font-size:42px; }
  .status { padding:6px 8px; border-radius:8px; font-weight:600; }
  .available { background:#e6fff9; color:#007a5f; }
  .rented { background:#fff2f2; color:#b90909; }
  .actions { margin-top:12px; display:flex; flex-wrap: wrap;  gap:8px; }
  .actions .btn {flex: 1 1 45%; font-size: 13px; padding: 7px 8px;white-space: nowrap;}
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; }
  .modal.show { display:flex; }
  .dialog { background:white; padding:18px; border-radius:12px; width:420px; }

    /* ===============================
    TABEL RIWAYAT RESPONSIVE
  ================================ */
  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    background: white;
    border-radius: 12px;
  }

  .rental-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1100px;
  }

  .rental-table th,
  .rental-table td {
    padding: 8px 10px;
    font-size: 13px;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid #e5e7eb;
  }

  .rental-table th {
    background: #f3f4f6;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .rental-table tr:hover {
    background: #f9fafb;
  }

  /* Tombol di tabel */
  .rental-table .btn {
    padding: 5px 8px;
    font-size: 12px;
    border-radius: 6px;
  }

  .dialog {
  background:white;
  padding:20px;
  border-radius:12px;
  width:420px;
}

.card:hover {
  transform: translateY(-4px);
  transition: 0.2s ease;
}

/*navbar shadow */
.navbar {
  transition: all 0.3s ease;
}

.navbar-brand {
  font-size: 20px;
  letter-spacing: 0.5px;
}

.nav-link {
  font-weight: 500;
  color: #333 !important;
}

.nav-link:hover {
  color: #198754 !important;
}

.navbar .btn {
  border-radius: 30px;
}

.navbar.scrolled {
  background: #fff !important;
  box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}

/*Footter*/
/* FOOTER ELEGANT */
.footer-elegant {
    background: linear-gradient(135deg, #00352d, #0a8c78);
    color: #333;
    border-top: 1px solid #e5e7eb;
}

.footer-elegant h5 {
    color: #feffc4;
    font-weight: 600;
}

.footer-elegant p,
.footer-elegant a,
.footer-elegant small {
    color: #ebe8e8;
}

.footer-elegant a {
    text-decoration: none;
    transition: all 0.3s ease;
}

.footer-elegant a:hover {
    color: #eae6e6;
    transform: translateX(3px);
}

.footer-elegant i {
    color: #f5f2f2;
}

.footer-elegant hr {
    border-color: #ddd;
}

/*Logo Navbar*/
.navbar-logo {
  height: 58px;
  width: auto;
  border-radius: 6px;
}


  /* ===============================
    MOBILE MODE
  ================================ */
  @media (max-width: 768px) {
    .rental-table {
      font-size: 12px;
      min-width: 900px;
    }
  }

  @media (max-width: 576px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
}


@media (max-width: 576px) {
  .card {
    padding: 10px;
  }

  .motor-img {
    height: 140px;
  }

  h3 {
    font-size: 15px;
  }
}
  body { font-family: Inter, sans-serif; padding:20px; background:#f6f7fb; }

  table { width:100%; border-collapse:collapse; }
  td, th { padding:8px; border-bottom:1px solid #eee; }
  footer { text-align:center; margin-top:20px; color:#666; }
</style>
</head>

<body>
<div class="container py-3">

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
  <div class="container">

    <!-- LOGO / BRAND -->
    <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#">
      <img src="img/Logo Rental.png" class="navbar-logo">
      <i class="fa-solid  text-success"></i>
      <span>Rental Merah Putih</span>
    </a>


    <!-- TOGGLE MOBILE -->
    <button class="navbar-toggler" type="button"
      data-bs-toggle="collapse"
      data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- MENU -->
    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">

        <li class="nav-item">
          <a class="nav-link active" href="#motorGrid">Motor</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="#footer">About</a>
        </li>

        <li class="nav-item ms-lg-3">
          <button id="adminBtn" class="btn btn-success px-4">
            <i class="fa-solid fa-lock"></i> Admin
          </button>
        </li>

      </ul>
    </div>
  </div>
</nav>


<p style="color:#666;font-size:13px;">
  Aman, Cepat dan Terjangkau.
</p>

<div id="infoBox" class="card mb-4 border-warning">
  <div class="card-body bg-warning-subtle">
    <p class="small text-danger mb-2">
      ‚ÑπÔ∏è Penyewaan dilakukan langsung di lokasi rental (07:00 - 00:00 WIT)
    </p>

    <h5 class="fw-bold">üì¢ Info Terkini</h5>
    <div id="infoContent" class="text-secondary">
      Tidak ada informasi saat ini.
    </div>
  </div>
</div>


<div id="motorGrid" class="grid"></div>

<!-- Modal Sewa -->
<div id="rentModal" class="modal">
  <div class="dialog">
    <h3 id="modalTitle" style="margin-bottom:10px;">Form Sewa Motor</h3>

    <form id="rentForm" style="display:flex;flex-direction:column;gap:10px;">
      <input type="hidden" id="bikeId" />

      <div>
        <label>Nama Penyewa</label>
        <input id="name" required style="width:100%;" />
      </div>

      <div>
        <label>No HP Penyewa</label>
        <input id="phone" type="tel" pattern="[0-9+]*" required style="width:100%;" />
      </div>

      <div>
        <label>Durasi (Jam)</label>
        <input id="hours" type="number" min="1" value="1" required style="width:100%;" />
      </div>

      <div>
        <label>Pilih Tanggal & Waktu Sewa</label>
        <input id="rentalDate" type="datetime-local" required style="width:100%;" />
      </div>

      <div style="display:flex;gap:20px;margin-top:6px;">
        <label><input type="checkbox" id="ktp"> KTP</label>
        <label><input type="checkbox" id="ktm"> KTM</label>
        <label><input type="checkbox" id="belumbayar"> Belum Bayar</label>
      </div>

      <div>
        <label>Sudah Bayar</label>
        <input id="sudahbayar" required style="width:100%;" />
      </div>
       
      <div>
        <label>Tarif per Jam</label>
        <input id="rate" type="number" readonly style="background:#eee;width:100%;" />
      </div>

      <div>
        <label>Total Harga</label>
        <input id="total" type="number" readonly style="background:#eee;width:100%;" />
      </div>

      <button id="submitRentBtn" class="btn btn-success w-100">
        Konfirmasi Sewa
      </button>

    </form>

    <button id="closeModal" class="btn btn-secondary w-100 mt-2">
      Batal
    </button>
  </div>
</div>



<script>
  // Tombol Batal modal
  const rentModal = document.getElementById("rentModal");
  document.getElementById("closeModal").onclick = () => {
    rentModal.classList.remove("show");
  };
</script>


<!-- MODAL LOGIN ADMIN -->
<div id="loginModal" class="modal">
  <div class="dialog">
    <h3>Login Admin</h3>

    <input
      id="adminEmail"
      type="email"
      placeholder="Email Admin"
      autocomplete="username"
      required
      style="width:100%;margin-bottom:10px;"
    />

    <input
      id="adminPass"
      type="password"
      placeholder="Password"
      autocomplete="current-password"
      required
      style="width:100%;margin-bottom:10px;"
    />

    <button
      class="btn"
      style="width:100%;"
      onclick="loginAdmin()"
    >
      Login
    </button>

    <button
      class="btn"
      style="width:100%;background:#777;margin-top:6px;"
      onclick="closeLogin()"
    >
      Batal
    </button>
  </div>
</div>


<!-- Admin Panel -->
<div id="adminPanel" class="card" style="margin-top:20px;display:none;">
  <h3>Admin Panel</h3>
  <h4>Info Terkini (Publik)</h4>
  <input id="infoTitle" placeholder="Judul info" style="width:100%;margin-bottom:6px;">
  <textarea id="infoMessage" placeholder="Isi info..." style="width:100%;height:60px;"></textarea>
  <button class="btn" onclick="saveInfo()">Simpan Info</button>

  <button id="addBikeBtn" class="btn"><i class="fa fa-plus"></i> Tambah Motor</button>
  
  <div id="addBikeModal" class="modal">
  <div class="dialog">
    <h3>Tambah Motor</h3>

    <input id="bikeName" placeholder="Nama motor" style="width:100%;margin-bottom:8px;">
    <input id="bikeRate" type="number" placeholder="Tarif per jam" style="width:100%;margin-bottom:8px;">
    <input id="bikeRateDay" type="number" placeholder="Tarif per hari" style="width:100%;margin-bottom:8px;">
    <textarea id="bikeDetail" placeholder="Detail motor" style="width:100%;height:70px;margin-bottom:8px;"></textarea>

    
    <label>Upload URL Gambar Dari Supabase</label>
    <input id="bikeImageURL" placeholder="https://..." style="width:100%;margin-bottom:8px;">

    <button id="saveBikeBtn" class="btn" style="width:100%;">Simpan</button>
    <button onclick="closeAddBike()" class="btn" style="background:#777;width:100%;margin-top:6px;">Batal</button>
  </div>
</div>
  
  <h4>Riwayat Sewa</h4>

  <button class="btn"
  style="background:#02396f;color:white;margin-bottom:10px;"
  onclick="downloadPdfSupabase()">
  <i class="fa fa-file-pdf"></i> Download PDF 
  </button>

  <button id="deleteAllRentalsBtn" class="btn" 
  style="background:#b90909;color:white;margin-bottom:10px;">
  <i class="fa fa-trash"></i> Hapus Semua Riwayat
  </button>
<div class="table-responsive">
  <table class="rental-table">
  <thead>
    <tr>
      <th>Nama</th>
      <th>Motor</th>
      <th>No HP Penyewa</th>
      <th>Durasi</th>
      <th>Total</th>
      <th>Mulai</th>
      <th>Selesai</th>
      <th>KTP/KTM/(Belum Bayar)</th>
      <th>Kembalikan</th>
      <th>Sudah Bayar</th>
      <th>Status</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody id="rentalTable"></tbody>
  </table>
</div>
</div>

</div>

<!-- Modal Detail Motor -->
<div id="detailModal" class="modal">
  <div class="dialog">
    <h3 id="detailTitle"></h3>

    <div id="detailText" style="margin:10px 0; font-size:14px; line-height:1.4;"></div>

    <button class="btn" style="width:100%;background:#777;margin-top:10px;"
      onclick="closeDetail()">Tutup</button>
  </div>
</div>

<!-- Footer Start -->
<footer id="footer" class="footer-elegant pt-5">
    <div class="container">
        <div class="row">

            <!-- INFO RENTAL -->
            <div class="col-lg-4 col-md-6 mb-4 text-start">
                <h5 class="mb-3">Rental Motor Merah Putih</h5>
                <p class="mb-2">
                    Layanan sewa motor per jam atau per hari dengan proses cepat,
                    aman, dan terpercaya.
                </p>
                <p class="mb-1">
                    <i class="fa fa-map-marker-alt me-2"></i>
                    Kel. Sasa, Jl.KH.Ahmad Dahlan
                </p>
                <p class="mb-1">
                    <i class="fa fa-phone-alt me-2"></i>
                    <a href="https://wa.me/6281376539558"
                      target="_blank"
                      class="text-light text-decoration-none">
                        +62 813-7653-9558
                    </a>
                </p>
                <p class="mb-1">
                    <i class="fa fa-envelope me-2"></i>
                    support@rentalmerahputih.id
                </p>
            </div>

            <!-- LINK PENTING -->
            <div class="col-lg-3 col-md-6 mb-4 text-start">
                <h5 class="mb-3">Link</h5>
                <ul class="list-unstyled">
                    <li class="mb-1">
                        <a href="#motorGrid" class="text-light text-decoration-none">
                            Daftar Motor
                        </a>
                    </li>
                    <li class="mb-1">
                        <a href="#infoBox" class="text-light text-decoration-none">
                            Informasi Rental
                        </a>
                    </li>
                </ul>
            </div>

            <!-- SOSIAL MEDIA -->
            <div class="col-lg-2 col-md-6 mb-4 text-start">
                <h5 class="mb-3">Ikuti Kami</h5>
                <div class="d-flex gap-3">

                    <!-- FACEBOOK (opsional) -->
                    <a href="https://facebook.com/" 
                      target="_blank"
                      class="text-light fs-5">
                        <i class="fab fa-facebook-f"></i>
                    </a>

                    <!-- INSTAGRAM -->
                    <a href="https://www.instagram.com/"
                      target="_blank"
                      class="text-light fs-5">
                        <i class="fab fa-instagram"></i>
                    </a>

                    <!-- WHATSAPP -->
                    <a href="https://wa.me/6281376539558"
                      target="_blank"
                      class="text-light fs-5">
                        <i class="fab fa-whatsapp"></i>
                    </a>

                </div>
            </div>

            <!-- MAP KECIL -->
            <div class="col-lg-3 col-md-6 mb-4 text-start">
                <h5 class="mb-3">Lokasi Kami</h5>
                <iframe
                    src="https://www.google.com/maps/embed?pb=!1m17!1m12!1m3!1d1560.0456191411097!2d127.32464263372357!3d0.7617983914577098!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m2!1m1!2s!5e1!3m2!1sen!2sid!4v1766329318688!5m2!1sen!2sid"
                    width="100%"
                    height="180"
                    style="border:0;"
                    allowfullscreen=""
                    loading="lazy">
                </iframe>
            </div>

        </div>

        <hr class="border-secondary">

        <div class="text-center pb-3">
            <small>
                ¬© 2025 Rental Motor Merah Putih. || IRENGIAS || UMMU ||
            </small>
        </div>

    </div>
</footer>
<!-- Footer End -->


<script>
/* ===============================
     1. INISIALISASI SUPABASE
   =============================== */

const SUPABASE_URL = "https://jjdvpopexxqzwxfmsqxa.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqZHZwb3BleHhxend4Zm1zcXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyOTk0MTEsImV4cCI6MjA4MTg3NTQxMX0.IN8WT5bqZo9CZNOdF619v5MefMxvEilDM1GNhHQ_W18";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===============================
     2. REALTIME SUBSCRIBE
   =============================== */
let isRenderingBikes = false;
let isRenderingRentals = false;

let refreshTimeout = null;

function safeRefresh() {
  if (refreshTimeout) return;

  refreshTimeout = setTimeout(async () => {
    if (!isRenderingBikes) {
      await loadBikes();
    }
    if (isAdmin && !isRenderingRentals) {
      await renderRentalsTable();
    }
    refreshTimeout = null;
  }, 300);
}

if (!window.bikesChannel) {
  window.bikesChannel = db.channel("bikes-change")
    .on("postgres_changes", { event: "*", schema: "public", table: "bikes" }, safeRefresh)
    .subscribe();
}

if (!window.rentalsChannel) {
  window.rentalsChannel = db.channel("rentals-change")
    .on("postgres_changes", { event: "*", schema: "public", table: "rentals" }, safeRefresh)
    .subscribe();
}



/* ===============================
     3. RENDER LIST MOTOR
   =============================== */
async function getActiveRental(bikeId) {
  const { data } = await db
    .from("rentals")
    .select("start_time, end_time")
    .eq("bike_id", bikeId)
    .eq("status", "ongoing")
    .maybeSingle();

  return data;
}

async function loadBikes() {
  if (isRenderingBikes) return;
  isRenderingBikes = true;

  const { data } = await db.from("bikes").select("*");

  const grid = document.getElementById("motorGrid");
  grid.innerHTML = "";

  for (const b of data) {
    let rentInfo = "";
    if (b.status === "rented") {
      const active = await getActiveRental(b.id);
      if (active) {
        rentInfo = `
          <p style="font-size:12px;color:#b90909;">
            Mulai: ${toLocal(active.start_time)}<br>
            Selesai: ${toLocal(active.end_time)}
          </p>
        `;
      }
    }

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="motor-img">
        <img src="${b.image_url || 'https://via.placeholder.com/200'}"
          style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
      </div>
      <h3>${b.name}</h3>
      <p>Rp ${b.rate_hour}/jam</p>
      <span class="status ${
        b.status === "available" ? "available" :
        b.status === "maintenance" ? "rented" : "rented"
      }">
        ${
          b.status === "available" ? "Tersedia" :
          b.status === "maintenance" ? "Rusak / Diperbaiki" :
          "Disewa"
        }
      </span>
      ${rentInfo}
      <div class="actions">
        <button class="btn" onclick="showDetail('${b.id}')">Detail</button>

        ${
          isAdmin ? `
            <button class="btn"
              onclick="openRent('${b.id}')"
              ${b.status !== "available" ? "disabled" : ""}>
              Sewa
            </button>

            <button class="btn" style="background:#b03"
              onclick="deleteBike('${b.id}')">Hapus</button>

            <button class="btn" style="background:#555"
              onclick="editBike('${b.id}')">Edit</button>

            ${
              b.status !== "maintenance"
                ? `<button class="btn" style="background:#d97706"
                    onclick="setMaintenance('${b.id}')">üöß Rusak</button>`
                : `<button class="btn" style="background:#059669"
                    onclick="setAvailable('${b.id}')">‚úÖ Ada</button>`
            }
          ` : ""
        }
      </div>
    `;
    grid.appendChild(div);
  }

  isRenderingBikes = false;
}



/* ===============================
   DETAIL MOTOR
================================= */

async function showDetail(id) {
  const { data: bike } = await db.from("bikes").select("*").eq("id", id).single();
  if (!bike) return alert("Data motor tidak ditemukan!");

  document.getElementById("detailTitle").innerText = bike.name;
  document.getElementById("detailText").innerHTML = `
    <b>Tarif per Jam:</b> Rp ${bike.rate_hour}<br>
    <b>Tarif per Hari:</b> Rp ${bike.rate_day}<br>
    <b>Status:</b> ${bike.status}<br><br>
    <b>Detail Motor:</b><br>${bike.detail || "-"}
  `;

  document.getElementById("detailModal").classList.add("show");
}

function closeDetail() {
  document.getElementById("detailModal").classList.remove("show");
}


/* ===============================
   LOAD PUBLIC INFO
================================= */
async function loadPublicInfo() {
  const { data, error } = await db
    .from("public_info")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(1);

  const box = document.getElementById("infoContent");

  if (error || !data || data.length === 0) {
    box.innerText = "Tidak ada informasi saat ini.";
    return;
  }

  const info = data[0];

  box.innerHTML = `
    <b>${info.title || "Info"}</b><br>
    ${info.message}<br>
    <small style="color:#888;">
      Diposting: ${toDateOnly(info.created_at)}
    </small>
  `;
}


function toDateOnly(dateInput) {
  if (!dateInput) return "-";
  const date = new Date(dateInput);
  return `${date.getDate().toString().padStart(2, "0")}-${(date.getMonth()+1)
    .toString().padStart(2,"0")}-${date.getFullYear()}`;
}



loadPublicInfo();


if (!window.publicInfoChannel) {
  window.publicInfoChannel = db
    .channel("public-info-realtime")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "public_info" },
      () => {
        loadPublicInfo();
      }
    )
    .subscribe();
}



async function saveInfo() {
  const title = document.getElementById("infoTitle").value;
  const message = document.getElementById("infoMessage").value;

  if (!message) return alert("Isi info terlebih dahulu!");

  const { data, error } = await db
    .from("public_info")
    .insert({ title, message })
    .select()
    .single();

  if (error) {
    alert("Gagal simpan info: " + error.message);
    return;
  }

  // üî• UPDATE UI LANGSUNG TANPA REFRESH
  document.getElementById("infoContent").innerHTML = `
    <b>${data.title || "Info"}</b><br>
    ${data.message}<br>
    <small style="color:#888;">
      Diposting: ${toDateOnly(data.created_at)}
    </small>
    <br>
  `;

  // reset input
  document.getElementById("infoTitle").value = "";
  document.getElementById("infoMessage").value = "";
  document.getElementById("infoBox").scrollIntoView({ behavior: "smooth" });


  alert("Info publik berhasil dipublikasikan!");
}


/* ===============================
     4. MODAL SEWA
   =============================== */

const rateInput = document.getElementById("rate");
const totalInput = document.getElementById("total");
const hoursInput = document.getElementById("hours");

async function openRent(id) {
    // Cek status motor dulu
  const { data: bike } = await db
    .from("bikes")
    .select("status, rate_hour, rate_day")
    .eq("id", id)
    .single();

  if (!bike || bike.status !== "available") {
    alert("Motor tidak tersedia / sedang diperbaiki!");
    return;
  }

  document.getElementById("bikeId").value = id;
  document.getElementById("modalTitle").innerHTML = "Form Sewa Motor";
  
  // Ambil data motor
  rateInput.value = bike.rate_hour;
  totalInput.value = bike.rate_hour * parseInt(hoursInput.value);

  rentModal.classList.add("show");

  // Update total otomatis saat durasi diubah
  function hitungTotal(hours, rateHour, rateDay) {
  if (hours >= 24) {
    const days = Math.floor(hours / 24);
    const sisaJam = hours % 24;
    return (days * rateDay) + (sisaJam * rateHour);
  } 
  return hours * rateHour;
  }

  // Hitung total saat modal dibuka
  totalInput.value = hitungTotal(
    parseInt(hoursInput.value),
    bike.rate_hour,
    bike.rate_day
  );

  // Update saat user ubah durasi
  hoursInput.oninput = null; // Hapus event listener lama
  hoursInput.oninput = () => {
    totalInput.value = hitungTotal(
      parseInt(hoursInput.value),
      bike.rate_hour,
      bike.rate_day
    );
  };

}


/* ===============================
     5. SIMPAN SEWA KE SUPABASE
   =============================== */
let isSubmittingRent = false;
document.getElementById("rentForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  if (isSubmittingRent) return; // üîí cegah dobel submit
  isSubmittingRent = true;

  const submitBtn = document.getElementById("submitRentBtn");
  submitBtn.disabled = true;
  submitBtn.innerText = "Memproses...";

  try {
    const bikeId = document.getElementById("bikeId").value;
    /* =========================
     1Ô∏è‚É£ CEK STATUS MOTOR DULU
     ========================= */
  const { data: cek, error: cekErr } = await db
    .from("bikes")
    .select("status")
    .eq("id", bikeId)
    .single();

  if (cekErr || !cek || cek.status !== "available") {
      throw new Error("Motor tidak tersedia / sedang diperbaiki!");
    }


  /* =========================
     2Ô∏è‚É£ AMBIL DATA FORM
     ========================= */
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const hours = parseInt(document.getElementById("hours").value);
  const rentalDate = new Date(document.getElementById("rentalDate").value);
  const hasKTP = document.getElementById("ktp").checked;
  const hasKTM = document.getElementById("ktm").checked;
  const hasbelumbayar = document.getElementById("belumbayar").checked;
  const sudahbayar = document.getElementById("sudahbayar").value;
  const total = parseInt(totalInput.value);

  const start = rentalDate;
  const end = new Date(start.getTime() + hours * 60 * 60 * 1000);

  const { error } = await db.from("rentals").insert({
    name,
    phone,
    bike_id: bikeId,
    duration: hours,
    total,
    start_time: start.toISOString(),
    end_time: end.toISOString(),
    return_time: null,
    status: "ongoing",
    ktp: hasKTP,
    ktm: hasKTM,
    belumbayar: hasbelumbayar,
    sudahbayar
  });

  if (error) throw error;

  // Update status motor
  await db.from("bikes").update({ status: "rented" }).eq("id", bikeId);

  /* ===========================
        KIRIM STRUK WA
     ===========================*/
// Ambil nama motor berdasarkan bikeId
  const { data: bikeData, error: bikeErr } = await db
    .from("bikes")
    .select("name")
    .eq("id", bikeId)
    .single();

  const bikeName = bikeData ? bikeData.name : "-";

  const struk = 
`*Sewa Motor Berhasil*

  Nama: ${name}
  No HP: ${phone}

  Motor: ${bikeName}
  Durasi: ${hours} jam

  Mulai: ${toLocal(start)}
  Selesai: ${toLocal(end)}

  Total: Rp ${total.toLocaleString()}

  KTP: ${hasKTP ? "Ya" : "Tidak"}
  KTM: ${hasKTM ? "Ya" : "Tidak"}
  Belum Bayar: ${hasbelumbayar ? "Ya" : "Tidak"} 

  Sudah Bayar: ${sudahbayar}

  Terima kasih telah menggunakan layanan kami.
  `;

  // Format WA agar 08xxxxx ‚Üí 628xxxxxx
  function formatWA(num) {
    return num.replace(/^\+?0/, "62").replace(/\s+/g, "");
  }

  const renterWA = formatWA(phone);

  const waText = encodeURIComponent(struk);

  // Kirim otomatis ke penyewa
  window.open(`https://wa.me/${renterWA}?text=${waText}`, "_blank");

  alert("Motor berhasil disewa dan struk terkirim via WhatsApp!");
    rentModal.classList.remove("show");

  } catch (err) {
    alert("Gagal menyewa: " + err.message);
  } finally {
    
    isSubmittingRent = false;
    submitBtn.disabled = false;
    submitBtn.innerText = "Konfirmasi Sewa";
  }
});



/* ==========================================
   MINTENANCE MOTOR (Motor Rusak/diperbaiki)
   ========================================== */

async function setMaintenance(bikeId) {
  if (!confirm("Set motor sebagai RUSAK / DIPERBAIKI?")) return;

  await db.from("bikes")
    .update({ status: "maintenance" })
    .eq("id", bikeId);

  alert("Motor diset ke status RUSAK / DIPERBAIKI");
  loadBikes();
}

async function setAvailable(bikeId) {
  if (!confirm("Set motor sebagai TERSEDIA kembali?")) return;

  await db.from("bikes")
    .update({ status: "available" })
    .eq("id", bikeId);

  alert("Motor siap disewa kembali");
  loadBikes();
}


/* ===============================
   6. ADMIN LOGIN TOGGLE (FIXED)
================================ */

let isAdmin = false;

/* LOGIN ADMIN */
async function loginAdmin() {
  const email = adminEmail.value;
  const password = adminPass.value;

  const { error } = await db.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);

  isAdmin = await checkIsAdmin();

  if (!isAdmin) {
    await db.auth.signOut();
    return alert("Akun ini bukan admin");
  }

  adminPanel.style.display = "block";
  loginModal.classList.remove("show");

  updateAdminButton();
  loadBikes();
  renderRentalsTable();

  alert("Login admin berhasil");
}

/* LOGOUT ADMIN */
async function logoutAdmin() {
  await db.auth.signOut();

  isAdmin = false;
  adminPanel.style.display = "none";

  const tbody = document.getElementById("rentalTable");
  if (tbody) tbody.innerHTML = "";

  updateAdminButton();
  loadBikes();
}

/* CEK ADMIN */
async function checkIsAdmin() {
  const { data } = await db.auth.getSession();
  if (!data.session) return false;

  const { data: admin } = await db
    .from("admins")
    .select("user_id")
    .eq("user_id", data.session.user.id)
    .single();

  return !!admin;
}

/* AUTH LISTENER (SATU KALI) */
db.auth.onAuthStateChange(async (_event, session) => {
  if (!session) {
    isAdmin = false;
    adminPanel.style.display = "none";
    updateAdminButton();
    loadBikes();
  }
});

/* INIT */
document.addEventListener("DOMContentLoaded", async () => {
  const { data } = await db.auth.getSession();
  isAdmin = data.session ? await checkIsAdmin() : false;
  adminPanel.style.display = isAdmin ? "block" : "none";
  updateAdminButton();
  initialRefresh();

  if (isAdmin) renderRentalsTable();

  adminBtn.onclick = () => {
    if (isAdmin) logoutAdmin();
    else loginModal.classList.add("show");
  };
});

/* UI */
function updateAdminButton() {
  adminBtn.innerHTML = isAdmin
    ? '<i class="fa-solid fa-unlock"></i> Logout'
    : '<i class="fa-solid fa-lock"></i> Admin';
}

function closeLogin() {
  loginModal.classList.remove("show");
}



/* ===============================
     7. LOAD RIWAYAT SEWA
   =============================== */

async function loadRentals() {
  const { data } = await db.from("rentals").select("*").order("start_time", { ascending: false });

  const tbody = document.getElementById("rentalTable");
  tbody.innerHTML = "";

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.bike_id}</td>
      <td>${r.duration} jam</td>
      <td>${r.status}</td>
    `;
    tbody.appendChild(tr);
  });
}

renderRentalsTable();


/* ===============================
   8. HELPER
   =============================== */

function numberWithDots(x) {
  if (x == null) return "0";
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Format waktu lokal
function toLocal(dateInput) {
  if (!dateInput) return "-";
  const date = typeof dateInput === "string" ? new Date(dateInput) : dateInput;

  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');

  const hh = String(date.getHours()).padStart(2, '0');
  const mm = String(date.getMinutes()).padStart(2, '0');

  return `${d}-${m}-${y} / ${hh}:${mm}`;
}



/* ===============================
   9. TAMBAH MOTOR (ADMIN) - simple prompt
   =============================== */

document.getElementById("addBikeBtn").onclick = () => {
  document.getElementById("addBikeModal").classList.add("show");
};
function closeAddBike() {
  document.getElementById("addBikeModal").classList.remove("show");
}

async function uploadImage(file, name) {
  const fileExt = file.name.split('.').pop();
  const fileName = `${name}-${Date.now()}.${fileExt}`;

  const { data, error } = await db.storage
    .from("motor-images")
    .upload(fileName, file);

  if (error) {
    alert("Upload gagal: " + error.message);
    return null;
  }

  const { data: urlData } = db.storage
    .from("motor-images")
    .getPublicUrl(fileName);

  return urlData.publicUrl;
}

document.getElementById("saveBikeBtn").onclick = async () => {
  const name = document.getElementById("bikeName").value;
  const rateHour = parseInt(document.getElementById("bikeRate").value);
  const rateDay = parseInt(document.getElementById("bikeRateDay").value);
  const detail = document.getElementById("bikeDetail").value;
  const imageURLInput = document.getElementById("bikeImageURL").value;

  if (!imageURLInput) {
    alert("Masukkan URL gambar!");
    return;
  }

  const { error } = await db.from("bikes").insert({
    name,
    rate_hour: rateHour,
    rate_day: rateDay,
    status: "available",
    image_url: imageURLInput,
    detail: detail
  });

  if (error) {
    alert("Gagal menambah motor: " + error.message);
    return;
  }

  alert("Motor berhasil ditambahkan!");
  closeAddBike();
  loadBikes();
};


/* ===============================
   10. RENDER RENTALS TABLE (dengan nama motor)
   =============================== */
async function renderRentalsTable() {
  if (!isAdmin || isRenderingRentals) return;
  isRenderingRentals = true;

  const { data: rentals, error } = await db
    .from("rentals")
    .select(`
      *,
      bikes(name)
    `)
    .order("start_time", { ascending: false }); // üî• TERBARU DI ATAS

  if (error) {
    console.error(error.message);
    isRenderingRentals = false;
    return;
  }

  const tbody = document.getElementById("rentalTable");
  tbody.innerHTML = ""; // ‚úÖ RESET SEKALI

  rentals.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.bikes?.name || "-"}</td>
      <td>${r.phone}</td>
      <td>${r.duration} jam</td>
      <td>Rp ${numberWithDots(r.total)}</td>
      <td>${toLocal(r.start_time)}</td>
      <td>${toLocal(r.end_time)}</td>
      <td>${r.ktp ? "KTP " : ""}${r.ktm ? "KTM " : ""}${r.belumbayar ? "Belum Bayar" : ""}</td>
      <td>${r.return_time ? toLocal(r.return_time) : "-"}</td>
      <td>${r.sudahbayar}</td>
      <td>${r.status}</td>
      <td>
        ${
          r.status === "ongoing"
            ? `<button class="btn" onclick="returnBike('${r.id}','${r.bike_id}')">Selesai</button>`
            : ""
        }
        <button class="btn" style="background:#b03;color:#fff;margin-left:6px;"
          onclick="deleteRentalSupabase('${r.id}','${r.bike_id}')">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr); // ‚úÖ APPEND saja (sudah DESC)
  });

  isRenderingRentals = false;
}


/* ===============================
    HAPUS SEMUA RIWAYAT SEWA (SAFE)
   =============================== */
document.getElementById("deleteAllRentalsBtn").onclick = async () => {

  // Buat dialog konfirmasi custom
  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.top = "0";
  wrapper.style.left = "0";
  wrapper.style.width = "100%";
  wrapper.style.height = "100%";
  wrapper.style.background = "rgba(0,0,0,0.5)";
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.justifyContent = "center";
  wrapper.style.zIndex = "9999";

  wrapper.innerHTML = `
    <div style="
      background:#fff;padding:20px;border-radius:10px;
      width:300px;text-align:center;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    ">
      <h3 style="margin-bottom:10px;">Konfirmasi</h3>
      <p style="margin-bottom:20px;">
        Yakin ingin menghapus <b>SEMUA</b> riwayat sewa?<br>
        Tindakan ini tidak bisa dibatalkan.
      </p>

      <button id="yesDeleteAll" 
        style="padding:10px 15px;background:#c20a0a;color:white;border:none;border-radius:5px;margin-right:10px;">
        Ya, Hapus
      </button>

      <button id="cancelDeleteAll" 
        style="padding:10px 15px;background:#555;color:white;border:none;border-radius:5px;">
        Batal
      </button>
    </div>
  `;

  document.body.appendChild(wrapper);

  // Jika memilih Batal ‚Üí tutup popup
  document.getElementById("cancelDeleteAll").onclick = () => {
    wrapper.remove();
  };

  // Jika memilih YA ‚Üí hapus semua data
  document.getElementById("yesDeleteAll").onclick = async () => {
    wrapper.remove(); // tutup popup

    const { error } = await db
      .from("rentals")
      .delete()
      .not("id", "is", null);

    if (error) {
      alert("Gagal menghapus semua riwayat: " + error.message);
      return;
    }

    // Reset semua motor jadi available
    await db.from("bikes")
      .update({ status: "available" })
      .not("id", "is", null);

    alert("Semua riwayat berhasil dihapus!");
    renderRentalsTable();
  };
};

/* ===============================
   11. KEMBALIKAN MOTOR (UPDATE)
   =============================== */

async function returnBike(rentalId, bikeId) {
  if (!confirm("Selesaikan sewa ini?")) return;

  // Ambil data rental + harga motor
  const { data: rental, error: err1 } = await db
    .from("rentals")
    .select("*, bikes(rate_hour, rate_day)")
    .eq("id", rentalId)
    .single();

  if (err1 || !rental) {
    console.error(err1);
    return alert("Gagal mengambil data rental!");
  }

  const start = new Date(rental.start_time);
  const end = new Date();  // waktu dikembalikan otomatis

  // Hitung durasi otomatis (jam)
  const diffMs = end - start;
  const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));

  // Hitung total otomatis
  const rateHour = rental.bikes.rate_hour;
  const rateDay  = rental.bikes.rate_day;

  // üî• HITUNG TOTAL SESUAI ATURAN
  let total = 0;

  if (diffHours >= 24) {
    const days = Math.floor(diffHours / 24);
    const extraHours = diffHours % 24;
    total = (days * rateDay) + (extraHours * rateHour);
  } else {
    total = diffHours * rateHour;
  }


  // Update rental lengkap + return_time dalam format ISO
  const { error: err2 } = await db
    .from("rentals")
    .update({
      duration: diffHours,
      total: total,
      status: "finished",
      return_time: end.toISOString()  // disimpan dalam ISO
    })
    .eq("id", rentalId);

  if (err2) {
    console.error(err2);
    return alert("Gagal update data sewa!");
  }

  // Motor kembali tersedia
  await db
    .from("bikes")
    .update({ status: "available" })
    .eq("id", bikeId);

  /* ===============================
       KIRIM PESAN WHATSAPP OTOMATIS
     =============================== */

  const text = `
  *Sewa Motor Telah Selesai*

  Nama: ${rental.name}
  Mulai: ${toLocal(start)}
  Kembali: ${toLocal(end)}
  Durasi: ${diffHours} jam
  Total: Rp ${total.toLocaleString("id-ID")}

  Terima kasih telah menggunakan layanan kami üòä
  `.trim();

    function formatWA(num) {
      return num.replace(/^\+?0/, "62").replace(/\s+/g, "");
    }

    const wa = formatWA(rental.phone);
    const msg = encodeURIComponent(text);

    // buka chat WA otomatis
    window.open(`https://wa.me/${wa}?text=${msg}`, "_blank");

    /* ===============================
      NOTIFIKASI SELESAI SEWA REELTIME
      =============================== */

    alert(
      `Sewa selesai!\n` +
      `Mulai   : ${toLocal(start)}\n` +
      `Kembali : ${toLocal(end)}\n` +
      `Durasi  : ${diffHours} jam\n` +
      `Total   : Rp ${total.toLocaleString()}`
    );

  renderRentalsTable();
  loadBikes();
}

/* ===============================
   12. HAPUS TRANSAKSI (SUPABASE)
   =============================== */

async function deleteRentalSupabase(rentalId, bikeId) {
  if (!confirm("Hapus transaksi ini?")) return;

  const { error } = await db.from("rentals").delete().eq("id", rentalId);
  if (error) return alert("Gagal hapus transaksi: " + error.message);

  // pastikan motor tersedia setelah hapus (opsional)
  await db.from("bikes").update({ status: "available" }).eq("id", bikeId);

  alert("Transaksi dihapus.");
}

/* ===============================
   13. HAPUS / EDIT MOTOR (ADMIN) - simple
   =============================== */

async function deleteBike(id) {
  if (!confirm("Yakin ingin menghapus motor ini?")) return;

  const { error } = await db
    .from("bikes")
    .delete()
    .eq("id", id);

  if (error) {
    alert("Gagal menghapus motor: " + error.message);
    return;
  }

  alert("Motor berhasil dihapus!");
  loadBikes(); // refresh card motor
}


async function editBike(id) {
  const { data: b } = await db.from("bikes").select("*").eq("id", id).single();

  const newName = prompt("Nama motor:", b.name);
  const newRate = prompt("Tarif/jam:", b.rate_hour);
  const newRateDay = prompt("Tarif/hari:", b.rate_day);
  const newImageURL = prompt("URL gambar baru (kosongkan jika tidak ganti):", b.image_url);
  const newDetail = prompt("Detail motor:", b.detail);

  let uploadedURL = b.image_url;

  if (newImageURL && newImageURL !== b.image_url) {
    uploadedURL = newImageURL;
  }

  await db.from("bikes")
    .update({ name: newName, rate_hour: newRate, rate_day: newRateDay, image_url: uploadedURL, detail: newDetail })
    .eq("id", id);

  loadBikes();
}


/* ===============================
   14. INITIAL REFRESH
   =============================== */

async function initialRefresh() {
  await loadBikes();
  if (isAdmin) {
    await renderRentalsTable();
  }
}


initialRefresh();

/* ===============================
   15. DOWNLOAD PDF RIWAYAT SEWA
   =============================== */

async function downloadPdfSupabase() {
  const { data: rentals } = await db
    .from("rentals")
    .select("*")
    .order("start_time", { ascending: false });

  if (!rentals || rentals.length === 0) {
    alert("Belum ada data sewa.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l", "pt", "a4");

  doc.setFontSize(14);
  doc.text("LAPORAN RIWAYAT SEWA MOTOR", 40, 40);

  const rows = [];

  for (const r of rentals) {
    const { data: bike } = await db
      .from("bikes")
      .select("name")
      .eq("id", r.bike_id)
      .single();

    rows.push([
    r.name || "-",
    bike ? bike.name : "-",
    r.phone || "-",
    r.duration ? r.duration + " jam" : "-",
    "Rp " + numberWithDots(r.total),
    toLocal(r.start_time),
    toLocal(r.end_time),                                  // Selesai
    (r.ktp ? "KTP " : "") + (r.ktm ? "KTM" : "") + (r.belumbayar ? "Belum Bayar" : "") || "-",  // KTP/KTM/Belum Bayar
    toLocal(r.return_time),                               // Kembalikan
    r.sudahbayar || "-",
    r.status || "-"
  ]);

  }

  doc.autoTable({
    startY: 70,
    head: [[
      "Nama", "Motor", "No HP", "Durasi",
      "Total", "Mulai","Selesai", "KTP/KTM/(Belum Bayar)","Kembalikan", "Sudah Bayar",  "Status"
    ]],
    body: rows,
    styles: { fontSize: 9 }
  });

  doc.save("Buku_Kas_Sewa_Motor.pdf");
}


</script>
</body>
</html>







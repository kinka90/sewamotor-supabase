<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aplikasi Sewa Motor Rental Merah Putih</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- jsPDF AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { font-family: Inter, sans-serif; padding:20px; background:#f6f7fb; }
  .container { max-width:1100px; margin:auto; }
  h1 { margin:0; font-size:22px; }
  .btn { background:#2b7a78; color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:18px; }
  .card { background:white; padding:12px; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); }
  .motor-img { height:140px; border-radius:8px; background:#eef; display:flex; align-items:center; justify-content:center; font-size:48px; }
  .status { padding:6px 8px; border-radius:8px; font-weight:600; }
  .available { background:#e6fff9; color:#007a5f; }
  .rented { background:#fff2f2; color:#b90909; }
  .actions { margin-top:10px; display:flex; gap:8px; }
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; }
  .modal.show { display:flex; }
  .dialog { background:white; padding:18px; border-radius:12px; width:420px; }
  table { width:100%; border-collapse:collapse; }
  td, th { padding:8px; border-bottom:1px solid #eee; }
  footer { text-align:center; margin-top:20px; color:#666; }
</style>
</head>

<body>
<div class="container">

<header style="display:flex;justify-content:space-between;align-items:center;">
  <h1>Aplikasi Sewa Motor Rental Merah Putih</h1>
  <button id="adminBtn" class="btn"><i class="fa-solid fa-lock"></i> Admin</button>
</header>

<p style="color:#666;font-size:13px;">
  Semua data tersimpan realtime di Supabase. Cocok untuk multi pengguna.
</p>

<div id="infoBox" class="card" style="margin:15px 0; background:#fff7e6;">
  <p style="font-size:13px;color:#62004e;">
    ‚ÑπÔ∏è Penyewaan dilakukan langsung di lokasi rental.  
    Status motor ditampilkan secara realtime.
  </p>
  <h3 style="margin-bottom:6px;">üì¢ Info Terkini</h3>
  <div id="infoContent" style="font-size:14px;color:#444;">
    Tidak ada informasi saat ini.
  </div>
</div>

<div id="motorGrid" class="grid"></div>

<!-- Modal Sewa -->
<div id="rentModal" class="modal">
  <div class="dialog">
    <h3 id="modalTitle" style="margin-bottom:10px;">Form Sewa Motor</h3>

    <form id="rentForm" style="display:flex;flex-direction:column;gap:10px;">
      <input type="hidden" id="bikeId" />

      <div>
        <label>Nama Penyewa</label>
        <input id="name" required style="width:100%;" />
      </div>

      <div>
        <label>No HP Penyewa</label>
        <input id="phone" type="tel" pattern="[0-9+]*" required style="width:100%;" />
      </div>

      <div>
        <label>Durasi (Jam)</label>
        <input id="hours" type="number" min="1" value="1" required style="width:100%;" />
      </div>

      <div>
        <label>Pilih Tanggal & Waktu Sewa</label>
        <input id="rentalDate" type="datetime-local" required style="width:100%;" />
      </div>

      <div style="display:flex;gap:20px;margin-top:6px;">
        <label><input type="checkbox" id="ktp"> KTP</label>
        <label><input type="checkbox" id="ktm"> KTM</label>
        <label><input type="checkbox" id="belumbayar"> Belum Bayar</label>
      </div>

      <div>
        <label>Sudah Bayar</label>
        <input id="sudahbayar" required style="width:100%;" />
      </div>
       
      <div>
        <label>Tarif per Jam</label>
        <input id="rate" type="number" readonly style="background:#eee;width:100%;" />
      </div>

      <div>
        <label>Total Harga</label>
        <input id="total" type="number" readonly style="background:#eee;width:100%;" />
      </div>

      <button class="btn" style="width:100%;margin-top:6px;">Konfirmasi Sewa</button>
    </form>

    <button id="closeModal" class="btn" style="width:100%;background:#777;margin-top:8px;">
      Batal
    </button>
  </div>
</div>



<script>
  // Tombol Batal modal
  const rentModal = document.getElementById("rentModal");
  document.getElementById("closeModal").onclick = () => {
    rentModal.classList.remove("show");
  };
</script>


<!-- MODAL LOGIN ADMIN -->
<div id="loginModal" class="modal">
  <div class="dialog">
    <h3>Login Admin</h3>

    <input
      id="adminEmail"
      type="email"
      placeholder="Email Admin"
      autocomplete="username"
      required
      style="width:100%;margin-bottom:10px;"
    />

    <input
      id="adminPass"
      type="password"
      placeholder="Password"
      autocomplete="current-password"
      required
      style="width:100%;margin-bottom:10px;"
    />

    <button
      class="btn"
      style="width:100%;"
      onclick="loginAdmin()"
    >
      Login
    </button>

    <button
      class="btn"
      style="width:100%;background:#777;margin-top:6px;"
      onclick="closeLogin()"
    >
      Batal
    </button>
  </div>
</div>


<!-- Admin Panel -->
<div id="adminPanel" class="card" style="margin-top:20px;display:none;">
  <h3>Admin Panel</h3>
  <h4>Info Terkini (Publik)</h4>
  <input id="infoTitle" placeholder="Judul info" style="width:100%;margin-bottom:6px;">
  <textarea id="infoMessage" placeholder="Isi info..." style="width:100%;height:60px;"></textarea>
  <button class="btn" onclick="saveInfo()">Simpan Info</button>

  <button id="addBikeBtn" class="btn"><i class="fa fa-plus"></i> Tambah Motor</button>
  
  <div id="addBikeModal" class="modal">
  <div class="dialog">
    <h3>Tambah Motor</h3>

    <input id="bikeName" placeholder="Nama motor" style="width:100%;margin-bottom:8px;">
    <input id="bikeRate" type="number" placeholder="Tarif per jam" style="width:100%;margin-bottom:8px;">
    <input id="bikeRateDay" type="number" placeholder="Tarif per hari" style="width:100%;margin-bottom:8px;">
    <textarea id="bikeDetail" placeholder="Detail motor" style="width:100%;height:70px;margin-bottom:8px;"></textarea>

    
    <label>Upload URL Gambar Dari Supabase</label>
    <input id="bikeImageURL" placeholder="https://..." style="width:100%;margin-bottom:8px;">

    <button id="saveBikeBtn" class="btn" style="width:100%;">Simpan</button>
    <button onclick="closeAddBike()" class="btn" style="background:#777;width:100%;margin-top:6px;">Batal</button>
  </div>
</div>
  
  <h4>Riwayat Sewa</h4>

  <button class="btn"
  style="background:#02396f;color:white;margin-bottom:10px;"
  onclick="downloadPdfSupabase()">
  <i class="fa fa-file-pdf"></i> Download PDF 
  </button>

  <button id="deleteAllRentalsBtn" class="btn" 
  style="background:#b90909;color:white;margin-bottom:10px;">
  <i class="fa fa-trash"></i> Hapus Semua Riwayat
  </button>
<table>
  <thead>
    <tr>
      <th>Nama</th>
      <th>Motor</th>
      <th>No HP Penyewa</th>
      <th>Durasi</th>
      <th>Total</th>
      <th>Mulai</th>
      <th>Selesai</th>
      <th>KTP/KTM/(Belum Bayar)</th>
      <th>Kembalikan</th>
      <th>Sudah Bayar</th>
      <th>Status</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody id="rentalTable"></tbody>
</table>
</div>

</div>

<!-- Modal Detail Motor -->
<div id="detailModal" class="modal">
  <div class="dialog">
    <h3 id="detailTitle"></h3>

    <div id="detailText" style="margin:10px 0; font-size:14px; line-height:1.4;"></div>

    <button class="btn" style="width:100%;background:#777;margin-top:10px;"
      onclick="closeDetail()">Tutup</button>
  </div>
</div>

<footer>Realtime by Supabase</footer>

<script>
/* ===============================
     1. INISIALISASI SUPABASE
   =============================== */

const SUPABASE_URL = "https://ifafjxuwhaikoiateisi.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmYWZqeHV3aGFpa29pYXRlaXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NDg4NjgsImV4cCI6MjA4MDEyNDg2OH0.id3IaMfUpgH8M_P2nB9G53scQdy5r7FHS_DrLpznHTY";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===============================
     2. REALTIME SUBSCRIBE
   =============================== */
let isRenderingBikes = false;
let isRenderingRentals = false;

let refreshTimeout = null;

function safeRefresh() {
  if (refreshTimeout) return;

  refreshTimeout = setTimeout(async () => {
    if (!isRenderingBikes) {
      await loadBikes();
    }
    if (isAdmin && !isRenderingRentals) {
      await renderRentalsTable();
    }
    refreshTimeout = null;
  }, 300);
}

if (!window.bikesChannel) {
  window.bikesChannel = db.channel("bikes-change")
    .on("postgres_changes", { event: "*", schema: "public", table: "bikes" }, safeRefresh)
    .subscribe();
}

if (!window.rentalsChannel) {
  window.rentalsChannel = db.channel("rentals-change")
    .on("postgres_changes", { event: "*", schema: "public", table: "rentals" }, safeRefresh)
    .subscribe();
}



/* ===============================
     3. RENDER LIST MOTOR
   =============================== */
async function getActiveRental(bikeId) {
  const { data } = await db
    .from("rentals")
    .select("start_time, end_time")
    .eq("bike_id", bikeId)
    .eq("status", "ongoing")
    .maybeSingle();

  return data;
}

async function loadBikes() {
  if (isRenderingBikes) return;
  isRenderingBikes = true;

  const { data } = await db.from("bikes").select("*");

  const grid = document.getElementById("motorGrid");
  grid.innerHTML = "";

  for (const b of data) {
    let rentInfo = "";
    if (b.status === "rented") {
      const active = await getActiveRental(b.id);
      if (active) {
        rentInfo = `
          <p style="font-size:12px;color:#b90909;">
            Mulai: ${toLocal(active.start_time)}<br>
            Selesai: ${toLocal(active.end_time)}
          </p>
        `;
      }
    }

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="motor-img">
        <img src="${b.image_url || 'https://via.placeholder.com/200'}"
          style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
      </div>
      <h3>${b.name}</h3>
      <p>Rp ${b.rate_hour}/jam</p>
      <span class="status ${
        b.status === "available" ? "available" :
        b.status === "maintenance" ? "rented" : "rented"
      }">
        ${
          b.status === "available" ? "Tersedia" :
          b.status === "maintenance" ? "Rusak / Diperbaiki" :
          "Disewa"
        }
      </span>
      ${rentInfo}
      <div class="actions">
        <button class="btn" onclick="showDetail('${b.id}')">Detail</button>

        ${
          isAdmin ? `
            <button class="btn"
              onclick="openRent('${b.id}')"
              ${b.status !== "available" ? "disabled" : ""}>
              Sewa
            </button>

            <button class="btn" style="background:#b03"
              onclick="deleteBike('${b.id}')">Hapus</button>

            <button class="btn" style="background:#555"
              onclick="editBike('${b.id}')">Edit</button>

            ${
              b.status !== "maintenance"
                ? `<button class="btn" style="background:#d97706"
                    onclick="setMaintenance('${b.id}')">üöß Rusak</button>`
                : `<button class="btn" style="background:#059669"
                    onclick="setAvailable('${b.id}')">‚úÖ Ada</button>`
            }
          ` : ""
        }
      </div>
    `;
    grid.appendChild(div);
  }

  isRenderingBikes = false;
}



/* ===============================
   DETAIL MOTOR
================================= */

async function showDetail(id) {
  const { data: bike } = await db.from("bikes").select("*").eq("id", id).single();
  if (!bike) return alert("Data motor tidak ditemukan!");

  document.getElementById("detailTitle").innerText = bike.name;
  document.getElementById("detailText").innerHTML = `
    <b>Tarif per Jam:</b> Rp ${bike.rate_hour}<br>
    <b>Tarif per Hari:</b> Rp ${bike.rate_day}<br>
    <b>Status:</b> ${bike.status}<br><br>
    <b>Detail Motor:</b><br>${bike.detail || "-"}
  `;

  document.getElementById("detailModal").classList.add("show");
}

function closeDetail() {
  document.getElementById("detailModal").classList.remove("show");
}


/* ===============================
   LOAD PUBLIC INFO
================================= */
async function loadPublicInfo() {
  const { data, error } = await db
    .from("public_info")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(1);

  const box = document.getElementById("infoContent");

  if (error || !data || data.length === 0) {
    box.innerText = "Tidak ada informasi saat ini.";
    return;
  }

  const info = data[0];

  box.innerHTML = `
    <b>${info.title || "Info"}</b><br>
    ${info.message}<br>
    <small style="color:#888;">
      Diposting: ${toDateOnly(info.created_at)}
    </small>
  `;
}


function toDateOnly(dateInput) {
  if (!dateInput) return "-";
  const date = new Date(dateInput);
  return `${date.getDate().toString().padStart(2, "0")}-${(date.getMonth()+1)
    .toString().padStart(2,"0")}-${date.getFullYear()}`;
}



loadPublicInfo();


if (!window.publicInfoChannel) {
  window.publicInfoChannel = db
    .channel("public-info-realtime")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "public_info" },
      () => {
        loadPublicInfo();
      }
    )
    .subscribe();
}



async function saveInfo() {
  const title = document.getElementById("infoTitle").value;
  const message = document.getElementById("infoMessage").value;

  if (!message) return alert("Isi info terlebih dahulu!");

  const { data, error } = await db
    .from("public_info")
    .insert({ title, message })
    .select()
    .single();

  if (error) {
    alert("Gagal simpan info: " + error.message);
    return;
  }

  // üî• UPDATE UI LANGSUNG TANPA REFRESH
  document.getElementById("infoContent").innerHTML = `
    <b>${data.title || "Info"}</b><br>
    ${data.message}<br>
    <small style="color:#888;">
      Diposting: ${toDateOnly(data.created_at)}
    </small>
    <br>
  `;

  // reset input
  document.getElementById("infoTitle").value = "";
  document.getElementById("infoMessage").value = "";
  document.getElementById("infoBox").scrollIntoView({ behavior: "smooth" });


  alert("Info publik berhasil dipublikasikan!");
}


/* ===============================
     4. MODAL SEWA
   =============================== */

const rateInput = document.getElementById("rate");
const totalInput = document.getElementById("total");
const hoursInput = document.getElementById("hours");

async function openRent(id) {
    // Cek status motor dulu
  const { data: bike } = await db
    .from("bikes")
    .select("status, rate_hour, rate_day")
    .eq("id", id)
    .single();

  if (!bike || bike.status !== "available") {
    alert("Motor tidak tersedia / sedang diperbaiki!");
    return;
  }

  document.getElementById("bikeId").value = id;
  document.getElementById("modalTitle").innerHTML = "Form Sewa Motor";
  
  // Ambil data motor
  rateInput.value = bike.rate_hour;
  totalInput.value = bike.rate_hour * parseInt(hoursInput.value);

  rentModal.classList.add("show");

  // Update total otomatis saat durasi diubah
  function hitungTotal(hours, rateHour, rateDay) {
  if (hours >= 24) {
    const days = Math.floor(hours / 24);
    const sisaJam = hours % 24;
    return (days * rateDay) + (sisaJam * rateHour);
  } 
  return hours * rateHour;
  }

  // Hitung total saat modal dibuka
  totalInput.value = hitungTotal(
    parseInt(hoursInput.value),
    bike.rate_hour,
    bike.rate_day
  );

  // Update saat user ubah durasi
  hoursInput.oninput = null; // Hapus event listener lama
  hoursInput.oninput = () => {
    totalInput.value = hitungTotal(
      parseInt(hoursInput.value),
      bike.rate_hour,
      bike.rate_day
    );
  };

}


/* ===============================
     5. SIMPAN SEWA KE SUPABASE
   =============================== */
document.getElementById("rentForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const bikeId = document.getElementById("bikeId").value;
    /* =========================
     1Ô∏è‚É£ CEK STATUS MOTOR DULU
     ========================= */
  const { data: cek, error: cekErr } = await db
    .from("bikes")
    .select("status")
    .eq("id", bikeId)
    .single();

  if (cekErr || !cek || cek.status !== "available") {
    alert("Motor tidak tersedia / sedang diperbaiki!");
    return;
  }

  /* =========================
     2Ô∏è‚É£ AMBIL DATA FORM
     ========================= */
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const hours = parseInt(document.getElementById("hours").value);
  const rentalDate = new Date(document.getElementById("rentalDate").value);
  const hasKTP = document.getElementById("ktp").checked;
  const hasKTM = document.getElementById("ktm").checked;
  const hasbelumbayar = document.getElementById("belumbayar").checked;
  const sudahbayar = document.getElementById("sudahbayar").value;
  const total = parseInt(totalInput.value);

  const start = rentalDate;
  const end = new Date(start.getTime() + hours * 60 * 60 * 1000);

  const { error } = await db.from("rentals").insert({
    name,
    phone,
    bike_id: bikeId,
    duration: hours,
    total,
    start_time: start.toISOString(),
    end_time: end.toISOString(),
    return_time: null,
    status: "ongoing",
    ktp: hasKTP,
    ktm: hasKTM,
    belumbayar: hasbelumbayar,
    sudahbayar
  });

  if (error) return alert("Gagal menyewa: " + error.message);

  // Update status motor
  await db.from("bikes").update({ status: "rented" }).eq("id", bikeId);

  /* ===========================
        KIRIM STRUK WA
     ===========================*/
// Ambil nama motor berdasarkan bikeId
  const { data: bikeData, error: bikeErr } = await db
    .from("bikes")
    .select("name")
    .eq("id", bikeId)
    .single();

  const bikeName = bikeData ? bikeData.name : "-";

  const struk = 
`*Sewa Motor Berhasil*

  Nama: ${name}
  No HP: ${phone}

  Motor: ${bikeName}
  Durasi: ${hours} jam

  Mulai: ${toLocal(start)}
  Selesai: ${toLocal(end)}

  Total: Rp ${total.toLocaleString()}

  KTP: ${hasKTP ? "Ya" : "Tidak"}
  KTM: ${hasKTM ? "Ya" : "Tidak"}
  Belum Bayar: ${hasbelumbayar ? "Ya" : "Tidak"} 

  Sudah Bayar: ${sudahbayar}

  Terima kasih telah menggunakan layanan kami.
  `;

  // Format WA agar 08xxxxx ‚Üí 628xxxxxx
  function formatWA(num) {
    return num.replace(/^\+?0/, "62").replace(/\s+/g, "");
  }

  const renterWA = formatWA(phone);

  const waText = encodeURIComponent(struk);

  // Kirim otomatis ke penyewa
  window.open(`https://wa.me/${renterWA}?text=${waText}`, "_blank");

  alert("Motor berhasil disewa dan struk terkirim via WhatsApp!");
  rentModal.classList.remove("show");
});



/* ==========================================
   MINTENANCE MOTOR (Motor Rusak/diperbaiki)
   ========================================== */

async function setMaintenance(bikeId) {
  if (!confirm("Set motor sebagai RUSAK / DIPERBAIKI?")) return;

  await db.from("bikes")
    .update({ status: "maintenance" })
    .eq("id", bikeId);

  alert("Motor diset ke status RUSAK / DIPERBAIKI");
  loadBikes();
}

async function setAvailable(bikeId) {
  if (!confirm("Set motor sebagai TERSEDIA kembali?")) return;

  await db.from("bikes")
    .update({ status: "available" })
    .eq("id", bikeId);

  alert("Motor siap disewa kembali");
  loadBikes();
}


/* ===============================
   6. ADMIN LOGIN TOGGLE (FIXED)
================================ */

let isAdmin = false;

/* LOGIN ADMIN */
async function loginAdmin() {
  const email = adminEmail.value;
  const password = adminPass.value;

  const { error } = await db.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);

  isAdmin = await checkIsAdmin();

  if (!isAdmin) {
    await db.auth.signOut();
    return alert("Akun ini bukan admin");
  }

  adminPanel.style.display = "block";
  loginModal.classList.remove("show");

  updateAdminButton();
  loadBikes();
  renderRentalsTable();

  alert("Login admin berhasil");
}

/* LOGOUT ADMIN */
async function logoutAdmin() {
  await db.auth.signOut();

  isAdmin = false;
  adminPanel.style.display = "none";

  const tbody = document.getElementById("rentalTable");
  if (tbody) tbody.innerHTML = "";

  updateAdminButton();
  loadBikes();
}

/* CEK ADMIN */
async function checkIsAdmin() {
  const { data } = await db.auth.getSession();
  if (!data.session) return false;

  const { data: admin } = await db
    .from("admins")
    .select("user_id")
    .eq("user_id", data.session.user.id)
    .single();

  return !!admin;
}

/* AUTH LISTENER (SATU KALI) */
db.auth.onAuthStateChange(async (_event, session) => {
  if (!session) {
    isAdmin = false;
    adminPanel.style.display = "none";
    updateAdminButton();
    loadBikes();
  }
});

/* INIT */
document.addEventListener("DOMContentLoaded", async () => {
  const { data } = await db.auth.getSession();
  isAdmin = data.session ? await checkIsAdmin() : false;
  adminPanel.style.display = isAdmin ? "block" : "none";
  updateAdminButton();
  initialRefresh();

  if (isAdmin) renderRentalsTable();

  adminBtn.onclick = () => {
    if (isAdmin) logoutAdmin();
    else loginModal.classList.add("show");
  };
});

/* UI */
function updateAdminButton() {
  adminBtn.innerHTML = isAdmin
    ? '<i class="fa-solid fa-unlock"></i> Logout'
    : '<i class="fa-solid fa-lock"></i> Admin';
}

function closeLogin() {
  loginModal.classList.remove("show");
}



/* ===============================
     7. LOAD RIWAYAT SEWA
   =============================== */

async function loadRentals() {
  const { data } = await db.from("rentals").select("*").order("start_time", { ascending: false });

  const tbody = document.getElementById("rentalTable");
  tbody.innerHTML = "";

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.bike_id}</td>
      <td>${r.duration} jam</td>
      <td>${r.status}</td>
    `;
    tbody.appendChild(tr);
  });
}

renderRentalsTable();


/* ===============================
   8. HELPER
   =============================== */

function numberWithDots(x) {
  if (x == null) return "0";
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Format waktu lokal
function toLocal(dateInput) {
  if (!dateInput) return "-";
  const date = typeof dateInput === "string" ? new Date(dateInput) : dateInput;

  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');

  const hh = String(date.getHours()).padStart(2, '0');
  const mm = String(date.getMinutes()).padStart(2, '0');

  return `${d}-${m}-${y} / ${hh}:${mm}`;
}



/* ===============================
   9. TAMBAH MOTOR (ADMIN) - simple prompt
   =============================== */

document.getElementById("addBikeBtn").onclick = () => {
  document.getElementById("addBikeModal").classList.add("show");
};
function closeAddBike() {
  document.getElementById("addBikeModal").classList.remove("show");
}

async function uploadImage(file, name) {
  const fileExt = file.name.split('.').pop();
  const fileName = `${name}-${Date.now()}.${fileExt}`;

  const { data, error } = await db.storage
    .from("motor-images")
    .upload(fileName, file);

  if (error) {
    alert("Upload gagal: " + error.message);
    return null;
  }

  const { data: urlData } = db.storage
    .from("motor-images")
    .getPublicUrl(fileName);

  return urlData.publicUrl;
}

document.getElementById("saveBikeBtn").onclick = async () => {
  const name = document.getElementById("bikeName").value;
  const rateHour = parseInt(document.getElementById("bikeRate").value);
  const rateDay = parseInt(document.getElementById("bikeRateDay").value);
  const detail = document.getElementById("bikeDetail").value;
  const imageURLInput = document.getElementById("bikeImageURL").value;

  if (!imageURLInput) {
    alert("Masukkan URL gambar!");
    return;
  }

  const { error } = await db.from("bikes").insert({
    name,
    rate_hour: rateHour,
    rate_day: rateDay,
    status: "available",
    image_url: imageURLInput,
    detail: detail
  });

  if (error) {
    alert("Gagal menambah motor: " + error.message);
    return;
  }

  alert("Motor berhasil ditambahkan!");
  closeAddBike();
  loadBikes();
};


/* ===============================
   10. RENDER RENTALS TABLE (dengan nama motor)
   =============================== */
async function renderRentalsTable() {
  if (!isAdmin) {
    const tbody = document.getElementById("rentalTable");
    if (tbody) tbody.innerHTML = "";
    return;
  }
  if (isRenderingRentals) return;
  isRenderingRentals = true;

  const { data: rentals, error } = await db
    .from("rentals")
    .select("*")
    .order("start_time", { ascending: false });

  if (error) {
    console.error("Gagal load rentals:", error.message);
    return;
  }

  const tbody = document.getElementById("rentalTable");
  tbody.innerHTML = "";

  for (const r of rentals) {
    const { data: b } = await db
      .from("bikes")
      .select("name")
      .eq("id", r.bike_id)
      .single();

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${b ? b.name : "-"}</td>
      <td>${r.phone}</td>
      <td>${r.duration} jam</td>
      <td>Rp ${numberWithDots(r.total)}</td>
      <td>${toLocal(r.start_time)}</td>
      <td>${toLocal(r.end_time)}</td>
      <td>${r.ktp ? "KTP " : ""}${r.ktm ? "KTM" : ""}${r.belumbayar ? "Belum Bayar" : ""}</td>
      <td>${r.return_time ? toLocal(r.return_time) : "-"}</td>
      <td>${r.sudahbayar}</td>
      <td>${r.status}</td>
      <td>
        ${r.status === "ongoing"
          ? `<button class="btn" onclick="returnBike('${r.id}','${r.bike_id}')">Selesai</button>`
          : ""
        }
        <button class="btn" style="background:#b03;color:#fff;margin-left:6px;"
          onclick="deleteRentalSupabase('${r.id}','${r.bike_id}')">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
  isRenderingRentals = false;
}




/* ===============================
    HAPUS SEMUA RIWAYAT SEWA (SAFE)
   =============================== */
document.getElementById("deleteAllRentalsBtn").onclick = async () => {

  // Buat dialog konfirmasi custom
  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.top = "0";
  wrapper.style.left = "0";
  wrapper.style.width = "100%";
  wrapper.style.height = "100%";
  wrapper.style.background = "rgba(0,0,0,0.5)";
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.justifyContent = "center";
  wrapper.style.zIndex = "9999";

  wrapper.innerHTML = `
    <div style="
      background:#fff;padding:20px;border-radius:10px;
      width:300px;text-align:center;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    ">
      <h3 style="margin-bottom:10px;">Konfirmasi</h3>
      <p style="margin-bottom:20px;">
        Yakin ingin menghapus <b>SEMUA</b> riwayat sewa?<br>
        Tindakan ini tidak bisa dibatalkan.
      </p>

      <button id="yesDeleteAll" 
        style="padding:10px 15px;background:#c20a0a;color:white;border:none;border-radius:5px;margin-right:10px;">
        Ya, Hapus
      </button>

      <button id="cancelDeleteAll" 
        style="padding:10px 15px;background:#555;color:white;border:none;border-radius:5px;">
        Batal
      </button>
    </div>
  `;

  document.body.appendChild(wrapper);

  // Jika memilih Batal ‚Üí tutup popup
  document.getElementById("cancelDeleteAll").onclick = () => {
    wrapper.remove();
  };

  // Jika memilih YA ‚Üí hapus semua data
  document.getElementById("yesDeleteAll").onclick = async () => {
    wrapper.remove(); // tutup popup

    const { error } = await db
      .from("rentals")
      .delete()
      .not("id", "is", null);

    if (error) {
      alert("Gagal menghapus semua riwayat: " + error.message);
      return;
    }

    // Reset semua motor jadi available
    await db.from("bikes")
      .update({ status: "available" })
      .not("id", "is", null);

    alert("Semua riwayat berhasil dihapus!");
    renderRentalsTable();
  };
};

/* ===============================
   11. KEMBALIKAN MOTOR (UPDATE)
   =============================== */

async function returnBike(rentalId, bikeId) {
  if (!confirm("Selesaikan sewa ini?")) return;

  // Ambil data rental + harga motor
  const { data: rental, error: err1 } = await db
    .from("rentals")
    .select("*, bikes(rate_hour)")
    .eq("id", rentalId)
    .single();

  if (err1 || !rental) {
    console.error(err1);
    return alert("Gagal mengambil data rental!");
  }

  const start = new Date(rental.start_time);
  const end = new Date();  // waktu dikembalikan otomatis

  // Hitung durasi otomatis (jam)
  const diffMs = end - start;
  const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));

  // Hitung total otomatis
  const rate = rental.bikes.rate_hour;
  const total = diffHours * rate;

  // Update rental lengkap + return_time dalam format ISO
  const { error: err2 } = await db
    .from("rentals")
    .update({
      duration: diffHours,
      total: total,
      status: "finished",
      return_time: end.toISOString()  // disimpan dalam ISO
    })
    .eq("id", rentalId);

  if (err2) {
    console.error(err2);
    return alert("Gagal update data sewa!");
  }

  // Motor kembali tersedia
  await db
    .from("bikes")
    .update({ status: "available" })
    .eq("id", bikeId);

  /* ===============================
       KIRIM PESAN WHATSAPP OTOMATIS
     =============================== */

  const text = `
  *Sewa Motor Telah Selesai*

  Nama: ${rental.name}
  Mulai: ${toLocal(start)}
  Kembali: ${toLocal(end)}
  Durasi: ${diffHours} jam
  Total: Rp ${total.toLocaleString("id-ID")}

  Terima kasih telah menggunakan layanan kami üòä
  `.trim();

    function formatWA(num) {
      return num.replace(/^\+?0/, "62").replace(/\s+/g, "");
    }

    const wa = formatWA(rental.phone);
    const msg = encodeURIComponent(text);

    // buka chat WA otomatis
    window.open(`https://wa.me/${wa}?text=${msg}`, "_blank");

    /* ===============================
      NOTIFIKASI SELESAI SEWA REELTIME
      =============================== */

    alert(
      `Sewa selesai!\n` +
      `Mulai   : ${toLocal(start)}\n` +
      `Kembali : ${toLocal(end)}\n` +
      `Durasi  : ${diffHours} jam\n` +
      `Total   : Rp ${total.toLocaleString()}`
    );

  renderRentalsTable();
  loadBikes();
}

/* ===============================
   12. HAPUS TRANSAKSI (SUPABASE)
   =============================== */

async function deleteRentalSupabase(rentalId, bikeId) {
  if (!confirm("Hapus transaksi ini?")) return;

  const { error } = await db.from("rentals").delete().eq("id", rentalId);
  if (error) return alert("Gagal hapus transaksi: " + error.message);

  // pastikan motor tersedia setelah hapus (opsional)
  await db.from("bikes").update({ status: "available" }).eq("id", bikeId);

  alert("Transaksi dihapus.");
}

/* ===============================
   13. HAPUS / EDIT MOTOR (ADMIN) - simple
   =============================== */

async function deleteBike(id) {
  if (!confirm("Yakin ingin menghapus motor ini?")) return;

  const { error } = await db
    .from("bikes")
    .delete()
    .eq("id", id);

  if (error) {
    alert("Gagal menghapus motor: " + error.message);
    return;
  }

  alert("Motor berhasil dihapus!");
  loadBikes(); // refresh card motor
}


async function editBike(id) {
  const { data: b } = await db.from("bikes").select("*").eq("id", id).single();

  const newName = prompt("Nama motor:", b.name);
  const newRate = prompt("Tarif/jam:", b.rate_hour);
  const newRateDay = prompt("Tarif/hari:", b.rate_day);
  const newImageURL = prompt("URL gambar baru (kosongkan jika tidak ganti):", b.image_url);
  const newDetail = prompt("Detail motor:", b.detail);

  let uploadedURL = b.image_url;

  if (newImageURL && newImageURL !== b.image_url) {
    uploadedURL = newImageURL;
  }

  await db.from("bikes")
    .update({ name: newName, rate_hour: newRate, rate_day: newRateDay, image_url: uploadedURL, detail: newDetail })
    .eq("id", id);

  loadBikes();
}


/* ===============================
   14. INITIAL REFRESH
   =============================== */

async function initialRefresh() {
  await loadBikes();
  if (isAdmin) {
    await renderRentalsTable();
  }
}


initialRefresh();

/* ===============================
   15. DOWNLOAD PDF RIWAYAT SEWA
   =============================== */

async function downloadPdfSupabase() {
  const { data: rentals } = await db
    .from("rentals")
    .select("*")
    .order("start_time", { ascending: false });

  if (!rentals || rentals.length === 0) {
    alert("Belum ada data sewa.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l", "pt", "a4");

  doc.setFontSize(14);
  doc.text("LAPORAN RIWAYAT SEWA MOTOR", 40, 40);

  const rows = [];

  for (const r of rentals) {
    const { data: bike } = await db
      .from("bikes")
      .select("name")
      .eq("id", r.bike_id)
      .single();

    rows.push([
    r.name || "-",
    bike ? bike.name : "-",
    r.phone || "-",
    r.duration ? r.duration + " jam" : "-",
    "Rp " + numberWithDots(r.total),
    toLocal(r.start_time),
    toLocal(r.end_time),                                  // Selesai
    (r.ktp ? "KTP " : "") + (r.ktm ? "KTM" : "") + (r.belumbayar ? "Belum Bayar" : "") || "-",  // KTP/KTM/Belum Bayar
    toLocal(r.return_time),                               // Kembalikan
    r.sudahbayar || "-",
    r.status || "-"
  ]);

  }

  doc.autoTable({
    startY: 70,
    head: [[
      "Nama", "Motor", "No HP", "Durasi",
      "Total", "Mulai","Selesai", "KTP/KTM/(Belum Bayar)","Kembalikan", "Sudah Bayar",  "Status"
    ]],
    body: rows,
    styles: { fontSize: 9 }
  });

  doc.save("Buku_Kas_Sewa_Motor.pdf");
}


</script>
</body>
</html>







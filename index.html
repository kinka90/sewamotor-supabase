<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aplikasi Sewa Motor - Supabase</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { font-family: Inter, sans-serif; padding:20px; background:#f6f7fb; }
  .container { max-width:1100px; margin:auto; }
  h1 { margin:0; font-size:22px; }
  .btn { background:#2b7a78; color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:18px; }
  .card { background:white; padding:12px; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); }
  .motor-img { height:140px; border-radius:8px; background:#eef; display:flex; align-items:center; justify-content:center; font-size:48px; }
  .status { padding:6px 8px; border-radius:8px; font-weight:600; }
  .available { background:#e6fff9; color:#007a5f; }
  .rented { background:#fff2f2; color:#b90909; }
  .actions { margin-top:10px; display:flex; gap:8px; }
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; }
  .modal.show { display:flex; }
  .dialog { background:white; padding:18px; border-radius:12px; width:420px; }
  table { width:100%; border-collapse:collapse; }
  td, th { padding:8px; border-bottom:1px solid #eee; }
  footer { text-align:center; margin-top:20px; color:#666; }
</style>
</head>

<body>
<div class="container">

<header style="display:flex;justify-content:space-between;align-items:center;">
  <h1>Aplikasi Sewa Motor â€“ Supabase</h1>
  <button id="adminBtn" class="btn"><i class="fa-solid fa-lock"></i> Admin</button>
</header>

<p style="color:#666;font-size:13px;">
  Semua data tersimpan realtime di Supabase. Cocok untuk multi pengguna.
</p>

<div id="motorGrid" class="grid"></div>

<!-- Modal Sewa -->
<div id="rentModal" class="modal">
  <div class="dialog">
    <h3 id="modalTitle" style="margin-bottom:10px;">Form Sewa Motor</h3>

    <form id="rentForm" style="display:flex;flex-direction:column;gap:10px;">
      <input type="hidden" id="bikeId" />

      <div>
        <label>Nama Penyewa</label>
        <input id="name" required style="width:100%;" />
      </div>

      <div>
        <label>No HP Penyewa</label>
        <input id="phone" type="tel" pattern="[0-9+]*" required style="width:100%;" />
      </div>

      <div>
        <label>Durasi (Jam)</label>
        <input id="hours" type="number" min="1" value="1" required style="width:100%;" />
      </div>

      <div>
        <label>Pilih Tanggal & Waktu Sewa</label>
        <input id="rentalDate" type="datetime-local" required style="width:100%;" />
      </div>

      <div style="display:flex;gap:20px;margin-top:6px;">
        <label><input type="checkbox" id="ktp"> KTP</label>
        <label><input type="checkbox" id="ktm"> KTM</label>
      </div>

      <div>
        <label>Tarif per Jam</label>
        <input id="rate" type="number" readonly style="background:#eee;width:100%;" />
      </div>

      <div>
        <label>Total Harga</label>
        <input id="total" type="number" readonly style="background:#eee;width:100%;" />
      </div>

      <button class="btn" style="width:100%;margin-top:6px;">Konfirmasi Sewa</button>
    </form>

    <button id="closeModal" class="btn" style="width:100%;background:#777;margin-top:8px;">
      Batal
    </button>
  </div>
</div>


<script>
  // Tombol Batal modal
  const rentModal = document.getElementById("rentModal");
  document.getElementById("closeModal").onclick = () => {
    rentModal.classList.remove("show");
  };
</script>



<!-- Admin Panel -->
<div id="adminPanel" class="card" style="margin-top:20px;display:none;">
  <h3>Admin Panel</h3>
  <button id="addBikeBtn" class="btn"><i class="fa fa-plus"></i> Tambah Motor</button>

  <h4>Riwayat Sewa</h4>

  <button id="deleteAllRentalsBtn" class="btn" 
  style="background:#b90909;color:white;margin-bottom:10px;">
  <i class="fa fa-trash"></i> Hapus Semua Riwayat
  </button>
<table>
  <thead>
    <tr>
      <th>Nama</th>
      <th>Motor</th>
      <th>No HP Penyewa</th>
      <th>Durasi</th>
      <th>Total</th>
      <th>Mulai</th>
      <th>Selesai</th>
      <th>KTP/KTM</th>
      <th>Kembalikan</th>
      <th>Status</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody id="rentalTable"></tbody>
</table>
</div>

</div>

<footer>Realtime by Supabase</footer>

<script>
/* ===============================
     1. INISIALISASI SUPABASE
   =============================== */

const SUPABASE_URL = "https://ifafjxuwhaikoiateisi.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmYWZqeHV3aGFpa29pYXRlaXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NDg4NjgsImV4cCI6MjA4MDEyNDg2OH0.id3IaMfUpgH8M_P2nB9G53scQdy5r7FHS_DrLpznHTY";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===============================
     2. REALTIME SUBSCRIBE
   =============================== */

db.channel("bikes-change")
  .on("postgres_changes", { event: "*", schema: "public", table: "bikes" },
    () => renderRentalsTable()
  )
  .subscribe();

db.channel("rentals-change")
  .on("postgres_changes", { event: "*", schema: "public", table: "rentals" },
    () => renderRentalsTable()
  )
  .subscribe();

/* ===============================
     3. RENDER LIST MOTOR
   =============================== */

async function loadBikes() {
  const { data } = await db.from("bikes").select("*");

  const grid = document.getElementById("motorGrid");
  grid.innerHTML = "";

  data.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="motor-img">${b.emoji}</div>
      <h3>${b.name}</h3>
      <p>Rp ${b.rate_hour}/jam</p>
      <span class="status ${b.status === 'available' ? 'available':'rented'}">
        ${b.status === "available" ? "Tersedia" : "Disewa"}
      </span>
      <div class="actions">
        <button class="btn" onclick="openRent('${b.id}')" ${b.status !== "available" ? "disabled":""}>Sewa</button>

        ${
          adminPanel.style.display === "block"
          ? `
            <button class="btn" style="background:#b03;color:#fff;"
              onclick="deleteBike('${b.id}')">
              Hapus
            </button>

            <button class="btn" style="background:#555;color:#fff;"
              onclick="editBike('${b.id}')">
              Edit
            </button>
          `
          : ""
        }
      </div>
    `;
    grid.appendChild(div);
  });
}

loadBikes();

/* ===============================
     4. MODAL SEWA
   =============================== */

const rateInput = document.getElementById("rate");
const totalInput = document.getElementById("total");
const hoursInput = document.getElementById("hours");

async function openRent(id) {
  document.getElementById("bikeId").value = id;
  document.getElementById("modalTitle").innerHTML = "Form Sewa Motor";
  
  // Ambil data motor
  const { data: bike } = await db.from("bikes").select("*").eq("id", id).single();
  rateInput.value = bike.rate_hour;
  totalInput.value = bike.rate_hour * parseInt(hoursInput.value);

  rentModal.classList.add("show");

  // Update total otomatis saat durasi diubah
  function hitungTotal(hours, rateHour, rateDay) {
  if (hours >= 24) {
    const days = Math.floor(hours / 24);
    const sisaJam = hours % 24;
    return (days * rateDay) + (sisaJam * rateHour);
  } 
  return hours * rateHour;
  }

  // Hitung total saat modal dibuka
  totalInput.value = hitungTotal(
    parseInt(hoursInput.value),
    bike.rate_hour,
    bike.rate_day
  );

  // Update saat user ubah durasi
  hoursInput.oninput = () => {
    totalInput.value = hitungTotal(
      parseInt(hoursInput.value),
      bike.rate_hour,
      bike.rate_day
    );
  };

}

document.getElementById("rentForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const bikeId = document.getElementById("bikeId").value;
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const phoneAdmin = document.getElementById("phoneAdmin").value;
  const hours = parseInt(document.getElementById("hours").value);
  const rentalDate = new Date(document.getElementById("rentalDate").value);
  const hasKTP = document.getElementById("ktp").checked;
  const hasKTM = document.getElementById("ktm").checked;
  const total = parseInt(totalInput.value);

  const start = rentalDate;
  const end = new Date(start.getTime() + hours * 60 * 60 * 1000);

  // Insert rental ke Supabase
  const { error } = await db.from("rentals").insert({
    name,
    phone,
    bike_id: bikeId,
    duration: hours,
    total,
    start_time: start.toISOString(),
    end_time: end.toISOString(),
    status: "ongoing",
    ktp: hasKTP,
    ktm: hasKTM
  });

  if (error) return alert("Gagal menyewa: " + error.message);

  // Update status motor
  await db.from("bikes").update({ status: "rented" }).eq("id", bikeId);

  /* ===========================
        KIRIM STRUK WA
     ===========================*/

  const struk = 
`*Sewa Motor Berhasil*

  Nama: ${name}
  No HP: ${phone}

  Motor: ${bikeId}
  Durasi: ${hours} jam

  Mulai: ${start.toLocaleString()}
  Selesai: ${end.toLocaleString()}

  Total: Rp ${total.toLocaleString()}

  KTP: ${hasKTP ? "Ya" : "Tidak"}
  KTM: ${hasKTM ? "Ya" : "Tidak"}

  Terima kasih telah menggunakan layanan kami.
  `;

  // Format WA agar 08xxxxx â†’ 628xxxxxx
  function formatWA(num) {
    return num.replace(/^\+?0/, "62").replace(/\s+/g, "");
  }

  const renterWA = formatWA(phone);

  const waText = encodeURIComponent(struk);

  // Kirim otomatis ke penyewa
  window.open(`https://wa.me/${renterWA}?text=${waText}`, "_blank");

  alert("Motor berhasil disewa dan struk terkirim via WhatsApp!");
  rentModal.classList.remove("show");
});


/* ===============================
     5. SIMPAN SEWA KE SUPABASE
   =============================== */
  document.getElementById("rentForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const bikeId = document.getElementById("bikeId").value;
    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const hours = parseInt(document.getElementById("hours").value);
    const rentalDate = new Date(document.getElementById("rentalDate").value);
    const hasKTP = document.getElementById("ktp").checked;
    const hasKTM = document.getElementById("ktm").checked;

    // Ambil data motor
    const { data: bike } = await db.from("bikes").select("*").eq("id", bikeId).single();

    // Hitung total
    function hitungTotal(hours, rateHour, rateDay) {
      if (hours >= 24) {
        const days = Math.floor(hours / 24);
        const sisaJam = hours % 24;
        return (days * rateDay) + (sisaJam * rateHour);
      }
      return hours * rateHour;
    }

    const total = hitungTotal(hours, bike.rate_hour, bike.rate_day);

    // Waktu mulai â†’ sesuai input user
    const start = rentalDate;
    const end = new Date(start.getTime() + hours * 60 * 60 * 1000);

    // Insert satu kali saja
    const { error } = await db.from("rentals").insert({
      name,
      phone,
      bike_id: bikeId,
      duration: hours,
      total,
      start_time: start.toISOString(),
      end_time: end.toISOString(),
      return_time: null,
      status: "ongoing",
      ktp: hasKTP,
      ktm: hasKTM
    });

    if (error) {
      alert("Gagal menyewa: " + error.message);
      return;
    }

    // Update status motor
    await db.from("bikes").update({ status: "rented" }).eq("id", bikeId);

    alert("Motor berhasil disewa!");
    rentModal.classList.remove("show");
  });



/* ===============================
     6. ADMIN LOGIN TOGGLE
   =============================== */

const adminPanel = document.getElementById("adminPanel");
document.getElementById("adminBtn").onclick = () => {
  adminPanel.style.display = adminPanel.style.display === "none" ? "block" : "none";
  loadBikes();
};


/* ===============================
     7. LOAD RIWAYAT SEWA
   =============================== */

async function loadRentals() {
  const { data } = await db.from("rentals").select("*").order("start_time", { ascending: false });

  const tbody = document.getElementById("rentalTable");
  tbody.innerHTML = "";

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.bike_id}</td>
      <td>${r.duration} jam</td>
      <td>${r.status}</td>
    `;
    tbody.appendChild(tr);
  });
}

renderRentalsTable();


/* ===============================
   8. HELPER
   =============================== */

function numberWithDots(x) {
  if (x == null) return "0";
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Format waktu lokal
function toLocal(dateInput) {
  if (!dateInput) return "-";
  const date = typeof dateInput === "string" ? new Date(dateInput) : dateInput;

  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');

  const hh = String(date.getHours()).padStart(2, '0');
  const mm = String(date.getMinutes()).padStart(2, '0');

  return `${d}-${m}-${y} / ${hh}:${mm}`;
}



/* ===============================
   9. TAMBAH MOTOR (ADMIN) - simple prompt
   =============================== */

document.getElementById("addBikeBtn").addEventListener("click", async () => {
  const name = prompt("Nama motor:");
  if (!name) return alert("Batal: nama kosong.");

  const rateHour = parseInt(prompt("Tarif per jam (angka):", "5000")) || 0;
  const rateDay = parseInt(prompt("Tarif per 24 jam (angka):", "60000")) || 0;
  const emoji = prompt("Emoji/ikon (opsional):", "ðŸ›µ") || "ðŸ›µ";

  const { error } = await db.from("bikes").insert([{
    name,
    rate_hour: rateHour,
    rate_day: rateDay,
    status: "available",
    emoji
  }]);

  if (error) return alert("Gagal tambah motor: " + error.message);
  alert("Motor ditambahkan.");
});

/* ===============================
   10. RENDER RENTALS TABLE (dengan nama motor)
   =============================== */
async function renderRentalsTable() {
  const { data: rentals } = await db
    .from("rentals")
    .select("*")
    .order("start_time", { ascending: false });

  const tbody = document.getElementById("rentalTable");
  tbody.innerHTML = "";

  for (const r of rentals) {
    const { data: b } = await db.from("bikes").select("*").eq("id", r.bike_id).single();
    const totalDisplay = "Rp " + numberWithDots(r.total);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${b ? b.name : '-'}</td>
      <td>${r.phone}</td>
      <td>${r.duration} jam</td>
      <td>${totalDisplay}</td>
      <td>${toLocal(r.start_time)}</td>
      <td>${toLocal(r.end_time)}</td>
      <td>${r.ktp ? "KTP " : ""}${r.ktm ? "KTM" : ""}</td>
      <td>${r.return_time ? toLocal(r.return_time) : "-"}</td>
      <td>${r.status}</td>
      <td>
        ${r.status === "ongoing" 
          ? `<button class="btn" onclick="returnBike('${r.id}','${r.bike_id}')">Selesai</button>` 
          : ""}
        <button class="btn" style="background:#b03;color:#fff;margin-left:6px;"
          onclick="deleteRentalSupabase('${r.id}','${r.bike_id}')">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}



/* ===============================
    HAPUS SEMUA RIWAYAT SEWA (SAFE)
   =============================== */
document.getElementById("deleteAllRentalsBtn").onclick = async () => {

  // Buat dialog konfirmasi custom
  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.top = "0";
  wrapper.style.left = "0";
  wrapper.style.width = "100%";
  wrapper.style.height = "100%";
  wrapper.style.background = "rgba(0,0,0,0.5)";
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.justifyContent = "center";
  wrapper.style.zIndex = "9999";

  wrapper.innerHTML = `
    <div style="
      background:#fff;padding:20px;border-radius:10px;
      width:300px;text-align:center;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    ">
      <h3 style="margin-bottom:10px;">Konfirmasi</h3>
      <p style="margin-bottom:20px;">
        Yakin ingin menghapus <b>SEMUA</b> riwayat sewa?<br>
        Tindakan ini tidak bisa dibatalkan.
      </p>

      <button id="yesDeleteAll" 
        style="padding:10px 15px;background:#c20a0a;color:white;border:none;border-radius:5px;margin-right:10px;">
        Ya, Hapus
      </button>

      <button id="cancelDeleteAll" 
        style="padding:10px 15px;background:#555;color:white;border:none;border-radius:5px;">
        Batal
      </button>
    </div>
  `;

  document.body.appendChild(wrapper);

  // Jika memilih Batal â†’ tutup popup
  document.getElementById("cancelDeleteAll").onclick = () => {
    wrapper.remove();
  };

  // Jika memilih YA â†’ hapus semua data
  document.getElementById("yesDeleteAll").onclick = async () => {
    wrapper.remove(); // tutup popup

    const { error } = await db
      .from("rentals")
      .delete()
      .not("id", "is", null);

    if (error) {
      alert("Gagal menghapus semua riwayat: " + error.message);
      return;
    }

    // Reset semua motor jadi available
    await db.from("bikes")
      .update({ status: "available" })
      .not("id", "is", null);

    alert("Semua riwayat berhasil dihapus!");
    renderRentalsTable();
  };
};


/* ===============================
   11. KEMBALIKAN MOTOR (UPDATE)
   =============================== */

async function returnBike(rentalId, bikeId) {
  if (!confirm("Selesaikan sewa ini?")) return;

  // Ambil data rental + harga motor
  const { data: rental, error: err1 } = await db
    .from("rentals")
    .select("*, bikes(rate_hour)")
    .eq("id", rentalId)
    .single();

  if (err1 || !rental) {
    console.error(err1);
    return alert("Gagal mengambil data rental!");
  }

  const start = new Date(rental.start_time);
  const end = new Date();  // waktu dikembalikan otomatis

  // Hitung durasi otomatis (jam)
  const diffMs = end - start;
  const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));

  // Hitung total otomatis
  const rate = rental.bikes.rate_hour;
  const total = diffHours * rate;

  // Update rental lengkap + return_time dalam format ISO
  const { error: err2 } = await db
    .from("rentals")
    .update({
      duration: diffHours,
      total: total,
      status: "finished",
      return_time: end.toISOString()  // disimpan dalam ISO
    })
    .eq("id", rentalId);

  if (err2) {
    console.error(err2);
    return alert("Gagal update data sewa!");
  }

  // Motor kembali tersedia
  await db
    .from("bikes")
    .update({ status: "available" })
    .eq("id", bikeId);

  alert(
    `Sewa selesai!\n` +
    `Mulai   : ${toLocal(start)}\n` +
    `Kembali : ${toLocal(end)}\n` +
    `Durasi  : ${diffHours} jam\n` +
    `Total   : Rp ${total.toLocaleString()}`
  );

  renderRentalsTable();
  loadBikes();
}

/* ===============================
   12. HAPUS TRANSAKSI (SUPABASE)
   =============================== */

async function deleteRentalSupabase(rentalId, bikeId) {
  if (!confirm("Hapus transaksi ini?")) return;

  const { error } = await db.from("rentals").delete().eq("id", rentalId);
  if (error) return alert("Gagal hapus transaksi: " + error.message);

  // pastikan motor tersedia setelah hapus (opsional)
  await db.from("bikes").update({ status: "available" }).eq("id", bikeId);

  alert("Transaksi dihapus.");
}

/* ===============================
   13. HAPUS / EDIT MOTOR (ADMIN) - simple
   =============================== */

async function deleteBike(id) {
  if (!confirm("Hapus motor ini?")) return;
  const { error } = await db.from("bikes").delete().eq("id", id);
  if (error) return alert("Gagal hapus motor: " + error.message);
  alert("Motor dihapus.");
}

async function editBike(id) {
  const { data: b } = await db.from("bikes").select("*").eq("id", id).single();
  if (!b) return alert("Motor tidak ditemukan.");

  const newName = prompt("Nama motor:", b.name);
  if (newName === null) return;
  const newHour = parseInt(prompt("Tarif per jam:", b.rate_hour)) || b.rate_hour;
  const newDay = parseInt(prompt("Tarif per 24 jam:", b.rate_day)) || b.rate_day;
  const newEmoji = prompt("Emoji:", b.emoji) || b.emoji;

  const { error } = await db.from("bikes").update({
    name: newName,
    rate_hour: newHour,
    rate_day: newDay,
    emoji: newEmoji
  }).eq("id", id);

  if (error) return alert("Gagal update motor: " + error.message);
  alert("Motor diperbarui.");
}

/* ===============================
   14. INITIAL REFRESH
   =============================== */

async function initialRefresh() {
  await loadBikes();
  await renderRentalsTable();
}

initialRefresh();

/* ===============================
   15. OPTIONAL: DOWNLOAD PDF (if jsPDF ter-include)
   =============================== */

async function downloadPdfSupabase() {
  // require jsPDF + autotable sudah diload di halaman
  const { data: rentals } = await db.from("rentals").select("*").order("start_time", { ascending: false });
  if (!rentals || rentals.length === 0) return alert("Belum ada data sewa.");

  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) return alert("jsPDF tidak ditemukan. Pastikan script jsPDF ada di halaman.");

  const doc = new jsPDF("l", "pt", "a4");
  doc.setFontSize(12);
  doc.text("Buku Kas Sewa Motor", 40, 40);

  const rows = [];
  for (const r of rentals) {
    const { data: bike } = await db.from("bikes").select("name").eq("id", r.bike_id).single();
    rows.push([
      r.name, bike?.name || r.bike_id, (r.duration || "-") + " jam",
      "Rp " + numberWithDots(r.total), new Date(r.start_time).toLocaleString(), new Date(r.end_time).toLocaleString(), r.status
    ]);
  }

  doc.autoTable({
    startY: 70,
    head: [["Nama", "Motor", "Durasi", "Total", "Mulai", "Selesai", "Status"]],
    body: rows,
    styles: { fontSize: 9 }
  });

  doc.save("BukuKasSewaMotor.pdf");
}

</script>
</body>
</html>




